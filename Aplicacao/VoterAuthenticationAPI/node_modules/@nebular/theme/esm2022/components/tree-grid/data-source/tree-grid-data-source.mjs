/*
 * @license
 * Copyright Akveo. All Rights Reserved.
 * Licensed under the MIT License. See License.txt in the project root for license information.
 */
import { Injectable } from '@angular/core';
import { BehaviorSubject, combineLatest } from 'rxjs';
import { map } from 'rxjs/operators';
import { NbDataSource } from '../../cdk/table/data-source';
import { NB_DEFAULT_ROW_LEVEL } from './tree-grid.model';
import * as i0 from "@angular/core";
import * as i1 from "./tree-grid-filter.service";
import * as i2 from "./tree-grid-sort.service";
import * as i3 from "./tree-grid.service";
import * as i4 from "./tree-grid-data.service";
export class NbTreeGridDataSource extends NbDataSource {
    constructor(sortService, filterService, treeGridService, treeGridDataService) {
        super();
        this.sortService = sortService;
        this.filterService = filterService;
        this.treeGridService = treeGridService;
        this.treeGridDataService = treeGridDataService;
        /** Stream emitting render data to the table (depends on ordered data changes). */
        this.renderData = new BehaviorSubject([]);
        this.filterRequest = new BehaviorSubject('');
        this.sortRequest = new BehaviorSubject(null);
    }
    setData(data, customGetters) {
        let presentationData = [];
        if (data) {
            presentationData = this.treeGridDataService.toPresentationNodes(data, customGetters);
        }
        this.data = new BehaviorSubject(presentationData);
        this.updateChangeSubscription();
    }
    connect(collectionViewer) {
        return this.renderData;
    }
    disconnect(collectionViewer) {
    }
    expand(row) {
        this.treeGridService.expand(this.data.value, row);
        this.data.next(this.data.value);
    }
    collapse(row) {
        this.treeGridService.collapse(this.data.value, row);
        this.data.next(this.data.value);
    }
    toggle(row, options) {
        this.treeGridService.toggle(this.data.value, row, options);
        this.data.next(this.data.value);
    }
    toggleByIndex(dataIndex, options) {
        const node = this.renderData.value && this.renderData.value[dataIndex];
        if (node) {
            this.toggle(node.data, options);
        }
    }
    getLevel(rowIndex) {
        const row = this.renderData.value[rowIndex];
        return row ? row.level : NB_DEFAULT_ROW_LEVEL;
    }
    sort(sortRequest) {
        this.sortRequest.next(sortRequest);
    }
    filter(searchQuery) {
        this.filterRequest.next(searchQuery);
    }
    updateChangeSubscription() {
        const dataStream = this.data;
        const filteredData = combineLatest([dataStream, this.filterRequest])
            .pipe(map(([data]) => this.treeGridDataService.copy(data)), map(data => this.filterData(data)));
        const sortedData = combineLatest([filteredData, this.sortRequest])
            .pipe(map(([data]) => this.sortData(data)));
        sortedData
            .pipe(map((data) => this.treeGridDataService.flattenExpanded(data)))
            .subscribe((data) => this.renderData.next(data));
    }
    filterData(data) {
        return this.filterService.filter(this.filterRequest.value, data);
    }
    sortData(data) {
        return this.sortService.sort(this.sortRequest.value, data);
    }
}
export class NbTreeGridDataSourceBuilder {
    constructor(filterService, sortService, treeGridService, treeGridDataService) {
        this.filterService = filterService;
        this.sortService = sortService;
        this.treeGridService = treeGridService;
        this.treeGridDataService = treeGridDataService;
    }
    create(data, customGetters) {
        const dataSource = new NbTreeGridDataSource(this.sortService, this.filterService, this.treeGridService, this.treeGridDataService);
        dataSource.setData(data, customGetters);
        return dataSource;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.1.0", ngImport: i0, type: NbTreeGridDataSourceBuilder, deps: [{ token: i1.NbTreeGridFilterService }, { token: i2.NbTreeGridSortService }, { token: i3.NbTreeGridService }, { token: i4.NbTreeGridDataService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.1.0", ngImport: i0, type: NbTreeGridDataSourceBuilder }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.1.0", ngImport: i0, type: NbTreeGridDataSourceBuilder, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.NbTreeGridFilterService }, { type: i2.NbTreeGridSortService }, { type: i3.NbTreeGridService }, { type: i4.NbTreeGridDataService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1ncmlkLWRhdGEtc291cmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2ZyYW1ld29yay90aGVtZS9jb21wb25lbnRzL3RyZWUtZ3JpZC9kYXRhLXNvdXJjZS90cmVlLWdyaWQtZGF0YS1zb3VyY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3JDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUszRCxPQUFPLEVBQWEsb0JBQW9CLEVBQThCLE1BQU0sbUJBQW1CLENBQUM7Ozs7OztBQU9oRyxNQUFNLE9BQU8sb0JBQXdCLFNBQVEsWUFBMkM7SUFZdEYsWUFBb0IsV0FBcUMsRUFDckMsYUFBeUMsRUFDekMsZUFBcUMsRUFDckMsbUJBQTZDO1FBQy9ELEtBQUssRUFBRSxDQUFDO1FBSlUsZ0JBQVcsR0FBWCxXQUFXLENBQTBCO1FBQ3JDLGtCQUFhLEdBQWIsYUFBYSxDQUE0QjtRQUN6QyxvQkFBZSxHQUFmLGVBQWUsQ0FBc0I7UUFDckMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUEwQjtRQVZqRSxrRkFBa0Y7UUFDakUsZUFBVSxHQUFHLElBQUksZUFBZSxDQUFrQyxFQUFFLENBQUMsQ0FBQztRQUV0RSxrQkFBYSxHQUFHLElBQUksZUFBZSxDQUFTLEVBQUUsQ0FBQyxDQUFDO1FBRWhELGdCQUFXLEdBQUcsSUFBSSxlQUFlLENBQWdCLElBQUksQ0FBQyxDQUFDO0lBT3hFLENBQUM7SUFFRCxPQUFPLENBQUksSUFBUyxFQUFFLGFBQStCO1FBQ25ELElBQUksZ0JBQWdCLEdBQW9DLEVBQUUsQ0FBQztRQUMzRCxJ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QWEsRUFDbEIsSUFBSSxDQUFDLGVBQWUsRUFDcEIsSUFBSSxDQUFDLG1CQUFtQixDQUN6QixDQUFDO1FBRUYsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDeEMsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQzs4R0FqQlUsMkJBQTJCO2tIQUEzQiwyQkFBMkI7OzJGQUEzQiwyQkFBMkI7a0JBRHZDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBBa3Zlby4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gU2VlIExpY2Vuc2UudHh0IGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IE5iQ29sbGVjdGlvblZpZXdlciB9IGZyb20gJy4uLy4uL2Nkay9jb2xsZWN0aW9ucy9jb2xsZWN0aW9uLXZpZXdlcic7XG5pbXBvcnQgeyBOYkRhdGFTb3VyY2UgfSBmcm9tICcuLi8uLi9jZGsvdGFibGUvZGF0YS1zb3VyY2UnO1xuaW1wb3J0IHsgTmJTb3J0YWJsZSwgTmJTb3J0UmVxdWVzdCB9IGZyb20gJy4uL3RyZWUtZ3JpZC1zb3J0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBOYlRyZWVHcmlkRGF0YVNlcnZpY2UgfSBmcm9tICcuL3RyZWUtZ3JpZC1kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgTmJUcmVlR3JpZEZpbHRlclNlcnZpY2UgfSBmcm9tICcuL3RyZWUtZ3JpZC1maWx0ZXIuc2VydmljZSc7XG5pbXBvcnQgeyBOYlRyZWVHcmlkU29ydFNlcnZpY2UgfSBmcm9tICcuL3RyZWUtZ3JpZC1zb3J0LnNlcnZpY2UnO1xuaW1wb3J0IHsgTmJHZXR0ZXJzLCBOQl9ERUZBVUxUX1JPV19MRVZFTCwgTmJUcmVlR3JpZFByZXNlbnRhdGlvbk5vZGUgfSBmcm9tICcuL3RyZWUtZ3JpZC5tb2RlbCc7XG5pbXBvcnQgeyBOYlRvZ2dsZU9wdGlvbnMsIE5iVHJlZUdyaWRTZXJ2aWNlIH0gZnJvbSAnLi90cmVlLWdyaWQuc2VydmljZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTmJGaWx0ZXJhYmxlIHtcbiAgZmlsdGVyKGZpbHRlclJlcXVlc3Q6IHN0cmluZyk7XG59XG5cbmV4cG9ydCBjbGFzcyBOYlRyZWVHcmlkRGF0YVNvdXJjZTxUPiBleHRlbmRzIE5iRGF0YVNvdXJjZTxOYlRyZWVHcmlkUHJlc2VudGF0aW9uTm9kZTxUPj5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbXBsZW1lbnRzIE5iU29ydGFibGUsIE5iRmlsdGVyYWJsZSB7XG4gIC8qKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGEgbmV3IGRhdGEgYXJyYXkgaXMgc2V0IG9uIHRoZSBkYXRhIHNvdXJjZS4gKi9cbiAgcHJpdmF0ZSBkYXRhOiBCZWhhdmlvclN1YmplY3Q8TmJUcmVlR3JpZFByZXNlbnRhdGlvbk5vZGU8VD5bXT47XG5cbiAgLyoqIFN0cmVhbSBlbWl0dGluZyByZW5kZXIgZGF0YSB0byB0aGUgdGFibGUgKGRlcGVuZHMgb24gb3JkZXJlZCBkYXRhIGNoYW5nZXMpLiAqL1xuICBwcml2YXRlIHJlYWRvbmx5IHJlbmRlckRhdGEgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE5iVHJlZUdyaWRQcmVzZW50YXRpb25Ob2RlPFQ+W10+KFtdKTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGZpbHRlclJlcXVlc3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4oJycpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgc29ydFJlcXVlc3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PE5iU29ydFJlcXVlc3Q+KG51bGwpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc29ydFNlcnZpY2U6IE5iVHJlZUdyaWRTb3J0U2VydmljZTxUPixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBmaWx0ZXJTZXJ2aWNlOiBOYlRyZWVHcmlkRmlsdGVyU2VydmljZTxUPixcbiAgICAgICAgICAgICAgcHJpdmF0ZSB0cmVlR3JpZFNlcnZpY2U6IE5iVHJlZUdyaWRTZXJ2aWNlPFQ+LFxuICAgICAgICAgICAgICBwcml2YXRlIHRyZWVHcmlkRGF0YVNlcnZpY2U6IE5iVHJlZUdyaWREYXRhU2VydmljZTxUPikge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBzZXREYXRhPE4+KGRhdGE6IE5bXSwgY3VzdG9tR2V0dGVycz86IE5iR2V0dGVyczxOLCBUPikge1xuICAgIGxldCBwcmVzZW50YXRpb25EYXRhOiBOYlRyZWVHcmlkUHJlc2VudGF0aW9uTm9kZTxUPltdID0gW107XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIHByZXNlbnRhdGlvbkRhdGEgPSB0aGlzLnRyZWVHcmlkRGF0YVNlcnZpY2UudG9QcmVzZW50YXRpb25Ob2RlcyhkYXRhLCBjdXN0b21HZXR0ZXJzKTtcbiAgICB9XG5cbiAgICB0aGlzLmRhdGEgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHByZXNlbnRhdGlvbkRhdGEpO1xuICAgIHRoaXMudXBkYXRlQ2hhbmdlU3Vic2NyaXB0aW9uKCk7XG4gIH1cblxuICBjb25uZWN0KFxuICAgIGNvbGxlY3Rpb25WaWV3ZXI6IE5iQ29sbGVjdGlvblZpZXdlcixcbiAgKTogT2JzZXJ2YWJsZTxOYlRyZWVHcmlkUHJlc2VudGF0aW9uTm9kZTxUPltdIHwgUmVhZG9ubHlBcnJheTxOYlRyZWVHcmlkUHJlc2VudGF0aW9uTm9kZTxUPj4+IHtcbiAgICByZXR1cm4gdGhpcy5yZW5kZXJEYXRhO1xuICB9XG5cbiAgZGlzY29ubmVjdChjb2xsZWN0aW9uVmlld2VyOiBOYkNvbGxlY3Rpb25WaWV3ZXIpIHtcbiAgfVxuXG4gIGV4cGFuZChyb3c6IFQpIHtcbiAgICB0aGlzLnRyZWVHcmlkU2VydmljZS5leHBhbmQodGhpcy5kYXRhLnZhbHVlLCByb3cpO1xuICAgIHRoaXMuZGF0YS5uZXh0KHRoaXMuZGF0YS52YWx1ZSk7XG4gIH1cblxuICBjb2xsYXBzZShyb3c6IFQpIHtcbiAgICB0aGlzLnRyZWVHcmlkU2VydmljZS5jb2xsYXBzZSh0aGlzLmRhdGEudmFsdWUsIHJvdyk7XG4gICAgdGhpcy5kYXRhLm5leHQodGhpcy5kYXRhLnZhbHVlKTtcbiAgfVxuXG4gIHRvZ2dsZShyb3c6IFQsIG9wdGlvbnM/OiBOYlRvZ2dsZU9wdGlvbnMpIHtcbiAgICB0aGlzLnRyZWVHcmlkU2VydmljZS50b2dnbGUodGhpcy5kYXRhLnZhbHVlLCByb3csIG9wdGlvbnMpO1xuICAgIHRoaXMuZGF0YS5uZXh0KHRoaXMuZGF0YS52YWx1ZSk7XG4gIH1cblxuICB0b2dnbGVCeUluZGV4KGRhdGFJbmRleDogbnVtYmVyLCBvcHRpb25zPzogTmJUb2dnbGVPcHRpb25zKSB7XG4gICAgY29uc3Qgbm9kZTogTmJUcmVlR3JpZFByZXNlbnRhdGlvbk5vZGU8VD4gPSB0aGlzLnJlbmRlckRhdGEudmFsdWUgJiYgdGhpcy5yZW5kZXJEYXRhLnZhbHVlW2RhdGFJbmRleF07XG4gICAgaWYgKG5vZGUpIHtcbiAgICAgIHRoaXMudG9nZ2xlKG5vZGUuZGF0YSwgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TGV2ZWwocm93SW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3Qgcm93ID0gdGhpcy5yZW5kZXJEYXRhLnZhbHVlW3Jvd0luZGV4XTtcbiAgICByZXR1cm4gcm93ID8gcm93LmxldmVsIDogTkJfREVGQVVMVF9ST1dfTEVWRUw7XG4gIH1cblxuICBzb3J0KHNvcnRSZXF1ZXN0OiBOYlNvcnRSZXF1ZXN0KSB7XG4gICAgdGhpcy5zb3J0UmVxdWVzdC5uZXh0KHNvcnRSZXF1ZXN0KTtcbiAgfVxuXG4gIGZpbHRlcihzZWFyY2hRdWVyeTogc3RyaW5nKSB7XG4gICAgdGhpcy5maWx0ZXJSZXF1ZXN0Lm5leHQoc2VhcmNoUXVlcnkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHVwZGF0ZUNoYW5nZVN1YnNjcmlwdGlvbigpIHtcbiAgICBjb25zdCBkYXRhU3RyZWFtID0gdGhpcy5kYXRhO1xuXG4gICAgY29uc3QgZmlsdGVyZWREYXRhID0gY29tYmluZUxhdGVzdChbZGF0YVN0cmVhbSwgdGhpcy5maWx0ZXJSZXF1ZXN0XSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKFtkYXRhXSkgPT4gdGhpcy50cmVlR3JpZERhdGFTZXJ2aWNlLmNvcHkoZGF0YSkpLFxuICAgICAgICBtYXAoZGF0YSA9PiB0aGlzLmZpbHRlckRhdGEoZGF0YSkpLFxuICAgICAgKTtcblxuICAgIGNvbnN0IHNvcnRlZERhdGEgPSBjb21iaW5lTGF0ZXN0KFtmaWx0ZXJlZERhdGEsIHRoaXMuc29ydFJlcXVlc3RdKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgoW2RhdGFdKSA9PiB0aGlzLnNvcnREYXRhKGRhdGEpKSxcbiAgICAgICk7XG5cbiAgICBzb3J0ZWREYXRhXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChkYXRhOiBOYlRyZWVHcmlkUHJlc2VudGF0aW9uTm9kZTxUPltdKSA9PiB0aGlzLnRyZWVHcmlkRGF0YVNlcnZpY2UuZmxhdHRlbkV4cGFuZGVkKGRhdGEpKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKGRhdGE6IE5iVHJlZUdyaWRQcmVzZW50YXRpb25Ob2RlPFQ+W10pID0+IHRoaXMucmVuZGVyRGF0YS5uZXh0KGRhdGEpKTtcbiAgfVxuXG4gIHByaXZhdGUgZmlsdGVyRGF0YShkYXRhOiBOYlRyZWVHcmlkUHJlc2VudGF0aW9uTm9kZTxUPltdKTogTmJUcmVlR3JpZFByZXNlbnRhdGlvbk5vZGU8VD5bXSB7XG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyU2VydmljZS5maWx0ZXIodGhpcy5maWx0ZXJSZXF1ZXN0LnZhbHVlLCBkYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgc29ydERhdGEoZGF0YTogTmJUcmVlR3JpZFByZXNlbnRhdGlvbk5vZGU8VD5bXSk6IE5iVHJlZUdyaWRQcmVzZW50YXRpb25Ob2RlPFQ+W10ge1xuICAgIHJldHVybiB0aGlzLnNvcnRTZXJ2aWNlLnNvcnQodGhpcy5zb3J0UmVxdWVzdC52YWx1ZSwgZGF0YSk7XG4gIH1cbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5iVHJlZUdyaWREYXRhU291cmNlQnVpbGRlcjxUPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmlsdGVyU2VydmljZTogTmJUcmVlR3JpZEZpbHRlclNlcnZpY2U8VD4sXG4gICAgICAgICAgICAgIHByaXZhdGUgc29ydFNlcnZpY2U6IE5iVHJlZUdyaWRTb3J0U2VydmljZTxUPixcbiAgICAgICAgICAgICAgcHJpdmF0ZSB0cmVlR3JpZFNlcnZpY2U6IE5iVHJlZUdyaWRTZXJ2aWNlPFQ+LFxuICAgICAgICAgICAgICBwcml2YXRlIHRyZWVHcmlkRGF0YVNlcnZpY2U6IE5iVHJlZUdyaWREYXRhU2VydmljZTxUPikge1xuICB9XG5cbiAgY3JlYXRlPE4+KGRhdGE6IE5bXSwgY3VzdG9tR2V0dGVycz86IE5iR2V0dGVyczxOLCBUPik6IE5iVHJlZUdyaWREYXRhU291cmNlPFQ+IHtcbiAgICBjb25zdCBkYXRhU291cmNlID0gbmV3IE5iVHJlZUdyaWREYXRhU291cmNlPFQ+KFxuICAgICAgdGhpcy5zb3J0U2VydmljZSxcbiAgICAgIHRoaXMuZmlsdGVyU2VydmljZSxcbiAgICAgIHRoaXMudHJlZUdyaWRTZXJ2aWNlLFxuICAgICAgdGhpcy50cmVlR3JpZERhdGFTZXJ2aWNlLFxuICAgICk7XG5cbiAgICBkYXRhU291cmNlLnNldERhdGEoZGF0YSwgY3VzdG9tR2V0dGVycyk7XG4gICAgcmV0dXJuIGRhdGFTb3VyY2U7XG4gIH1cbn1cbiJdfQ==